<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>çµ±åˆãƒãƒƒãƒ—</title>

    <!-- favicon -->
    <link rel="icon" href="./static/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="./static/favicon.png">
    <link rel="shortcut icon" href="./static/favicon.ico">

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet">

    <style>
    :root { --brand-green: rgb(14,83,12); }

    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, Helvetica, sans-serif;
      overflow: hidden;            /* ãƒ¢ãƒã‚¤ãƒ«ã§ä½™è¨ˆãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢ */
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    /* åœ°å›³ã‚¿ã‚¤ãƒ«ã®è‰²èª¿è£œæ­£ */
    .leaflet-tile-pane img {
      filter: saturate(1.8) contrast(1.2) brightness(1.0);
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ */
    .menu-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(260px, 90%, 640px);
      z-index: 1000;
      display: flex;
      gap: .5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;       /* Firefox */
    }
    .menu-bar::-webkit-scrollbar { display: none; }  /* Chrome/Safari */

    .menu-bar button {
      flex: 1 0 auto;
      white-space: nowrap;
    }

    /* ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ */
    .custom-icon {
      position: relative;
      z-index: 1;
      width: 50px; height: 50px;
      background: var(--brand-green);
      border: 2px solid #ccc;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .custom-icon::after {
      content: '';
      position: absolute;
      left: 50%; bottom: -11px;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 15px solid var(--brand-green);
      z-index: -1;
    }
    .icon-image {
      width: 90%; height: 90%;
      background-size: cover;
      background-position: center;
      border-radius: 50%;
      border: 1px solid #aaa;
    }

    /* è©³ç´°ãƒ‘ãƒãƒ« */
    .details-panel {
      position: fixed;
      top: 0; left: -400px;
      width: 400px; max-width: 90%;
      height: 100%;
      overflow-y: auto;
      transition: left .3s ease;
      z-index: 1001;
    }
    .details-panel.active {
      left: 0;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨èª¿æ•´ (â‰¤768px) */
    @media (max-width: 768px) {
      .custom-icon {
        width: 40px; height: 40px;
      }
      .custom-icon::after {
        bottom: -9px;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 12px solid var(--brand-green);
      }
      .details-panel {
        width: 100%;
        left: 100%;
      }
      .details-panel.active {
        left: 0;
      }
      .menu-bar {
        bottom: 10px;
        gap: .4rem;
      }
    }


  /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒãƒãƒƒãƒ—ä¸Šã«é‡ãªã‚‹ã‚ˆã†ã« */
  #back-btn {
    position: fixed;
    top: 20px;
    left: 70px;
    z-index: 999;

    /* ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ— */
    padding: 0.6rem 1.0rem;   /* ç¸¦æ¨ªã¨ã‚‚ã«åºƒã‚ã« */
    font-size: 1.0rem;        /* å°‘ã—å¤§ãã‚ã®æ–‡å­— */

    /* è¦‹ãŸç›® */
    background-color: #3fe1f7;
    color: #000000;
    border: none;
  }
  #back-btn .bi-arrow-left {
    font-size: 1.0rem;
    vertical-align: middle;
  }


  </style>

  </head>

  <body>
    <!-- â† ã“ã“ã‹ã‚‰è¿½åŠ ï¼šæˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <a id="back-btn" href="/" class="btn btn-light btn-lg">
      <i class="bi bi-arrow-left"></i> æˆ»ã‚‹
    </a>
  

    <div id="map"></div>

    <!-- è©³ç´°ãƒ‘ãƒãƒ« -->
    <div id="details-panel" class="details-panel bg-white shadow p-3">
      <button class="btn-close float-end" onclick="hideDetails()"></button>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ -->
    <div
      class="menu-bar bg-white shadow rounded-pill p-2 d-flex gap-2 align-items-center">
      <button class="btn btn-light">ğŸ  ã™ã¹ã¦</button>
      <button class="btn btn-light">ğŸ” æ¤œç´¢</button>
      <button class="btn btn-light">ğŸ´ ã‚°ãƒ«ãƒ¡</button>
      <button class="btn btn-light">ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</button>
      <button class="btn btn-light">ğŸ“„ è©³ç´°æƒ…å ±</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    /* ========== åœ°å›³åˆæœŸåŒ– ========== */
    const INITIAL_CENTER = [35.486417749642015, 139.3428098153942];
    const map = L.map('map').setView(INITIAL_CENTER, 18);
    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        attribution:
          '&copy; <a href="https://www.esri.com/">Esri</a>, Maxar, Earthstar Geographics',
        maxZoom: 18,
      }
    ).addTo(map);

    /* ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
    const toRad = (d) => (d * Math.PI) / 180;
    const toDeg = (r) => (r * 180) / Math.PI;
    const EARTH_R = 6371000;
    function getScreenAngle() {
      return (
        (screen.orientation && screen.orientation.angle) ||
        window.orientation ||
        0
      );
    }
    function calcBearing(lat1, lon1, lat2, lon2) {
      const Ï†1 = toRad(lat1),
        Ï†2 = toRad(lat2),
        Î»1 = toRad(lon1),
        Î»2 = toRad(lon2);
      const y = Math.sin(Î»2 - Î»1) * Math.cos(Ï†2);
      const x =
        Math.cos(Ï†1) * Math.sin(Ï†2) -
        Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î»2 - Î»1);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    /* ========== ã‚¹ãƒãƒƒãƒˆãƒãƒ¼ã‚«ãƒ¼ ========== */
    function createCustomIcon(url) {
      return L.divIcon({
        className: "",
        html: `<div class="custom-icon"><div class="icon-image" style="background-image:url('${url}')"></div></div>`,
        iconSize: [50, 60],
        iconAnchor: [25, 60],
      });
    }
    const spots = [
      { location: [35.48604116703019, 139.34128951057255], image: "./static/sunset.webp", name: "K1å·é¤¨" },
      { location: [35.48650866834297, 139.34112683577234], image: "./static/sunset.webp", name: "K2å·é¤¨" },
      { location: [35.48565158052546, 139.34141709865116], image: "./static/sunset.webp", name: "K3å·é¤¨" },
      { location: [35.485683613095844, 139.3419922129912], image: "./static/sunset.webp", name: "K4å·é¤¨" },
      { location: [35.485597402140684, 139.34321173217694], image: "./static/sunset.webp", name: "KAITã‚¢ãƒªãƒ¼ãƒŠ" },
      { location: [35.4860692562503, 139.34187073632998], image: "./static/sunset.webp", name: "å…ˆé€²ç ”" },
      { location: [35.48714378031437, 139.34102852276388], image: "./static/sunset.webp", name: "ãƒã‚¤ã‚ª" },
      { location: [35.4876058212225, 139.34111663074825], image: "./static/sunset.webp", name: "è‡ªå‹•è»Š" },
      { location: [35.48768007599212, 139.34208759034047], image: "./static/sunset.webp", name: "ãƒ­ãƒœãƒƒãƒˆ" },
      { location: [35.48638279161658, 139.34182473387625], image: "./static/sunset.webp", name: "åºƒå ´" },
      { location: [35.487920311541316, 139.3430478210974], image: "./static/sunset.webp", name: "è‡ªå‹•è»Š" },
      { location: [35.4867846462545, 139.34246309957499], image: "./static/sunset.webp", name: "å·¥æˆ¿" },
      { location: [35.486649238937936, 139.34321411804413], image: "./static/sunset.webp", name: "åºƒå ´" },
    ];
    spots.forEach((s) =>
      L.marker(s.location, { icon: createCustomIcon(s.image) })
        .addTo(map)
        .on("click", () =>
          showDetails({
            image: s.image,
            name: s.name,
            description:
              "ã“ã“ã«ã‚¹ãƒãƒƒãƒˆã®èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚Lorem ipsum dolor sit ametâ€¦",
            address: "æ±äº¬éƒ½å“å·åŒºæ±å…«æ½®1",
            phone: "00-1234-5678",
          })
        )
    );

    /* ========== è©³ç´°ãƒ‘ãƒãƒ« (å…ƒã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾) ========== */
    function showDetails(c) {
      const p = document.getElementById("details-panel");
      p.innerHTML = `
        <button class="btn-close float-end" onclick="hideDetails()"></button>
        <img src="${c.image}" alt="${c.name}" class="img-fluid rounded mb-3">
        <h2 class="fs-4">${c.name}</h2>
        <p class="text-muted mb-3">${c.description}</p>
        <div class="border-top pt-3">
          <div><strong>ä½æ‰€:</strong> ${c.address}</div>
          <div><strong>é›»è©±ç•ªå·:</strong> ${c.phone}</div>
        </div>`;
      p.classList.add("active");
    }
    function hideDetails() {
      document.getElementById("details-panel").classList.remove("active");
    }
    map.on("click", hideDetails);

    /* ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ ========== */
    let userMarker = null;
    let lastPos = null;
    let currentHeading = 0;
    function userHTML(heading) {
      return `
        <div style="position:relative;width:40px;height:40px">
          <div class="direction-wedge" style="
            position:absolute;top:-20px;left:-20px;width:80px;height:80px;
            background:radial-gradient(circle at 50% 50%,rgba(0,122,255,.4) 0%,rgba(0,122,255,0) 80%);
            clip-path:polygon(50% 50%,25% 0%,75% 0%);
            transform:rotate(${heading}deg);transform-origin:40px 40px;"></div>
          <div style="position:absolute;top:0;left:0;width:40px;height:40px;border-radius:50%;
            background:rgba(0,122,255,.2);border:2px solid rgba(0,122,255,.3);"></div>
          <div style="position:absolute;top:8px;left:8px;width:24px;height:24px;border-radius:50%;
            background:#007AFF;border:2px solid #fff;"></div>
        </div>`;
    }
    function renderUser(lat, lon, heading) {
      lastPos = [lat, lon];
      if (!userMarker) {
        userMarker = L.marker([lat, lon], {
          icon: L.divIcon({
            html: userHTML(heading),
            className: "",
            iconSize: [40, 40],
            iconAnchor: [20, 20],
          }),
        }).addTo(map);
      } else {
        /* HTML ã‚’ä¸¸ã”ã¨å†ç”Ÿæˆ â†’ å‘ããŒç¢ºå®Ÿã«æ›´æ–° */
        userMarker.setLatLng([lat, lon]);
        userMarker.setIcon(
          L.divIcon({
            html: userHTML(heading),
            className: "",
            iconSize: [40, 40],
            iconAnchor: [20, 20],
          })
        );
      }
    }

    /* ========== æ–¹ä½ã®é©ç”¨ ========= */
    function applyHeading(raw) {
      if (raw == null) return;
      const deg = (raw + getScreenAngle()) % 360;
      currentHeading = deg;
      console.log("Heading:", deg.toFixed(1));
      if (lastPos) renderUser(lastPos[0], lastPos[1], deg);
    }

    /* ========== 1) AbsoluteOrientationSensor ========= */
    (function () {
      try {
        if ("AbsoluteOrientationSensor" in window) {
          const sen = new AbsoluteOrientationSensor({ frequency: 30 });
          sen.addEventListener("reading", () => {
            const [x, y, z, w] = sen.quaternion;
            const yaw =
              (Math.atan2(
                2 * (w * z + x * y),
                1 - 2 * (y * y + z * z)
              ) *
                180) /
              Math.PI;
            applyHeading((yaw + 360) % 360);
          });
          sen.start();
          return; // æ©Ÿèƒ½ã™ã‚Œã°ä»–ã¯ä¸è¦
        }
      } catch (e) {
        console.warn("AbsoluteOrientationSensor error", e);
      }
    })();

    /* ========== 2) DeviceOrientationEvent (webkit / alpha) ========= */
    (function () {
      function handler(ev) {
        if (ev.webkitCompassHeading != null)
          return applyHeading(ev.webkitCompassHeading);
        if (ev.alpha != null) return applyHeading((360 - ev.alpha) % 360);
      }
      if (typeof DeviceOrientationEvent !== "undefined") {
        if (DeviceOrientationEvent.requestPermission) {
          DeviceOrientationEvent.requestPermission()
            .then((r) =>
              r === "granted"
                ? addEventListener("deviceorientation", handler, true)
                : console.warn("DeviceOrientation permission denied")
            )
            .catch(console.error);
        } else {
          addEventListener("deviceorientationabsolute", handler, true);
          addEventListener("deviceorientation", handler, true);
        }
      }
    })();

    /* ========== 3) DeviceOrientationEvent.absolute ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ ========= */
    (function () {
      function handler(ev) {
        if (ev.absolute && ev.alpha != null)
          applyHeading((360 - ev.alpha) % 360);
      }
      addEventListener("deviceorientation", handler, true);
    })();

    /* ========== 4) GPS ç§»å‹•ãƒ™ã‚¯ãƒˆãƒ«è£œå®Œ ========= */
    let lastBearingPos = null;
    function gpsBearing(lat, lon) {
      if (!lastBearingPos) {
        lastBearingPos = [lat, lon];
        return null;
      }
      const [pl, pn] = lastBearingPos;
      const d =
        EARTH_R *
        2 *
        Math.asin(
          Math.sqrt(
            Math.sin(toRad((lat - pl) / 2)) ** 2 +
              Math.cos(toRad(pl)) *
                Math.cos(toRad(lat)) *
                Math.sin(toRad((lon - pn) / 2)) ** 2
          )
        );
      if (d < 2) return null; // 2 m æœªæº€ â†’ ãƒã‚¤ã‚º
      lastBearingPos = [lat, lon];
      return calcBearing(pl, pn, lat, lon);
    }

    /* ========== Geolocation ========= */
    if ("geolocation" in navigator) {
      navigator.geolocation.watchPosition(
        ({ coords: { latitude, longitude } }) => {
          const fallback = gpsBearing(latitude, longitude);
          if (fallback != null && currentHeading === 0) currentHeading = fallback;
          renderUser(latitude, longitude, currentHeading);
        },
        (e) => console.error("Geolocation error", e),
        { enableHighAccuracy: true, maximumAge: 1500, timeout: 7000 }
      );
    } else alert("Geolocation API ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");

    /* ========== åˆæœŸåŒ–çµ‚äº† ========== */
    hideDetails();
  </script>

  </body>
</html>
