<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>統合マップ</title>

  <!-- favicon -->
  <link rel="icon" href="./static/favicon.ico" type="image/x-icon">
  <link rel="icon" type="image/png" href="./static/favicon.png">
  <link rel="shortcut icon" href="./static/favicon.ico">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <!-- Bootstrap Icons CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    rel="stylesheet">

  <style>
    :root { --brand-green: rgb(14,83,12); }

    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, Helvetica, sans-serif;
      overflow: hidden;            /* モバイルで余計なスクロールを防止 */
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    /* 地図タイルの色調補正 */
    .leaflet-tile-pane img {
      filter: saturate(1.8) contrast(1.2) brightness(1.0);
    }

    /* メニューバー */
    .menu-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(260px, 90%, 640px);
      z-index: 1000;
      display: flex;
      gap: .5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;       /* Firefox */
    }
    .menu-bar::-webkit-scrollbar { display: none; }  /* Chrome/Safari */

    .menu-bar button {
      flex: 1 0 auto;
      white-space: nowrap;
    }

    /* カスタムピン */
    .custom-icon {
      position: relative;
      z-index: 1;
      width: 50px; height: 50px;
      background: var(--brand-green);
      border: 2px solid #ccc;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .custom-icon::after {
      content: '';
      position: absolute;
      left: 50%; bottom: -11px;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 15px solid var(--brand-green);
      z-index: -1;
    }
    .icon-image {
      width: 90%; height: 90%;
      background-size: cover;
      background-position: center;
      border-radius: 50%;
      border: 1px solid #aaa;
    }

    /* 詳細パネル */
    .details-panel {
      position: fixed;
      top: 0; left: -400px;
      width: 400px; max-width: 90%;
      height: 100%;
      overflow-y: auto;
      transition: left .3s ease;
      z-index: 1001;
    }
    .details-panel.active {
      left: 0;
    }

    /* モバイル用調整 (≤768px) */
    @media (max-width: 768px) {
      .custom-icon {
        width: 40px; height: 40px;
      }
      .custom-icon::after {
        bottom: -9px;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 12px solid var(--brand-green);
      }
      .details-panel {
        width: 100%;
        left: 100%;
      }
      .details-panel.active {
        left: 0;
      }
      .menu-bar {
        bottom: 10px;
        gap: .4rem;
      }
    }
  </style>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4TPL68169Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4TPL68169Q');
  </script>
</head>

<body>
  <div id="map"></div>

  <!-- 詳細パネル -->
  <div id="details-panel" class="details-panel bg-white shadow p-3">
    <button class="btn-close float-end" onclick="hideDetails()"></button>
  </div>

  <!-- メニューバー -->
  <div class="menu-bar bg-white shadow rounded-pill p-2 d-flex gap-2 align-items-center">
    <button class="btn btn-light">🏠 すべて</button>
    <button class="btn btn-light">🔍 検索</button>
    <button class="btn btn-light">🍴 グルメ</button>
    <button class="btn btn-light">🛍️ ショッピング</button>
    <button class="btn btn-light">📄 詳細情報</button>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ========== 地図初期化 ========== */
    const INITIAL_CENTER = [35.486417749642015, 139.3428098153942];
    const map = L.map('map').setView(INITIAL_CENTER, 18);

    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        attribution:
          '&copy; <a href="https://www.esri.com/">Esri</a>, Maxar, Earthstar Geographics, and the GIS User Community',
        maxZoom: 18
      }
    ).addTo(map);

    /* ========== 共通ユーティリティ ========== */
    const toRad = d => (d * Math.PI) / 180;
    const toDeg = r => (r * 180) / Math.PI;

    /* 2点間ベアリング（モバイルタイプ式） */
    function bearing(lat1, lon1, lat2, lon2) {
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const λ1 = toRad(lon1), λ2 = toRad(lon2);
      const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
      const x =
        Math.cos(φ1) * Math.sin(φ2) -
        Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    /* 画面回転角 (0,90,180,270) */
    function getScreenAngle() {
      return (
        (screen.orientation && screen.orientation.angle) ||
        window.orientation ||
        0
      );
    }

    /* ========== カスタムピン生成 ========== */
    function createCustomIcon(imageUrl) {
      return L.divIcon({
        className: '',
        html: `
          <div class="custom-icon">
            <div class="icon-image" style="background-image:url('${imageUrl}')"></div>
          </div>
        `,
        iconSize: [50, 60],
        iconAnchor: [25, 60]
      });
    }

    /* ========== スポットデータ ========== */
    const markers = [
      { location: [35.48604116703019, 139.34128951057255], image: './static/sunset.webp', name: 'K1号館' },
      { location: [35.48650866834297, 139.34112683577234], image: './static/sunset.webp', name: 'K2号館' },
      { location: [35.48565158052546, 139.34141709865116], image: './static/sunset.webp', name: 'K3号館' },
      { location: [35.485683613095844, 139.3419922129912], image: './static/sunset.webp', name: 'K4号館' },
      { location: [35.485597402140684, 139.34321173217694], image: './static/sunset.webp', name: 'KAITアリーナ' },
      { location: [35.4860692562503, 139.34187073632998], image: './static/sunset.webp', name: '先進研' },
      { location: [35.48714378031437, 139.34102852276388], image: './static/sunset.webp', name: 'バイオ' },
      { location: [35.4876058212225, 139.34111663074825], image: './static/sunset.webp', name: '自動車' },
      { location: [35.48768007599212, 139.34208759034047], image: './static/sunset.webp', name: 'ロボット' },
      { location: [35.48638279161658, 139.34182473387625], image: './static/sunset.webp', name: '広場' },
      { location: [35.487920311541316, 139.3430478210974], image: './static/sunset.webp', name: '自動車' },
      { location: [35.4867846462545, 139.34246309957499], image: './static/sunset.webp', name: '工房' },
      { location: [35.486649238937936, 139.34321411804413], image: './static/sunset.webp', name: '広場' }
    ];

    /* ========== マーカー配置 ========== */
    markers.forEach(mData => {
      const m = L.marker(mData.location, { icon: createCustomIcon(mData.image) }).addTo(map);
      m.on('click', () => {
        showDetails({
          image: mData.image,
          name: mData.name,
          description: 'ここに、スポットの説明が表示されます。Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.',
          address: '東京都品川区東八潮1',
          phone: '00-1234-5678'
        });
      });
    });

    /* ========== 詳細パネル ========== */
    function showDetails(content) {
      const panel = document.getElementById('details-panel');
      panel.innerHTML = `
        <button class="btn-close float-end" onclick="hideDetails()"></button>
        <img src="${content.image}" alt="${content.name}" class="img-fluid rounded mb-3">
        <h2 class="fs-4">${content.name}</h2>
        <div class="d-flex gap-2 mb-3">
          <button class="btn btn-outline-secondary">❤️ 4</button>
          <button class="btn btn-outline-secondary">📥 保存</button>
          <button class="btn btn-outline-secondary">📤 シェア</button>
        </div>
        <p class="text-muted mb-3">${content.description}</p>
        <div class="border-top pt-3">
          <div><strong>住所:</strong> ${content.address}</div>
          <div><strong>電話番号:</strong> ${content.phone}</div>
        </div>
      `;
      panel.classList.add('active');
    }
    function hideDetails() {
      document.getElementById('details-panel').classList.remove('active');
    }
    map.on('click', hideDetails);

    /* ========== ユーザーマーカー ========== */
    let userMarker = null;
    let lastPos = null;
    let currentHeading = 0;

    function createUserHTML(heading) {
      return `
        <div style="position:relative;width:40px;height:40px">
          <div class="direction-wedge" style="
            position:absolute;top:-20px;left:-20px;width:80px;height:80px;
            background:radial-gradient(circle at 50% 50%,rgba(0,122,255,.4) 0%,rgba(0,122,255,0) 80%);
            clip-path:polygon(50% 50%,25% 0%,75% 0%);
            transform:rotate(${heading}deg);transform-origin:40px 40px;"></div>
          <div style="position:absolute;top:0;left:0;width:40px;height:40px;border-radius:50%;
            background:rgba(0,122,255,.2);border:2px solid rgba(0,122,255,.3);"></div>
          <div style="position:absolute;top:8px;left:8px;width:24px;height:24px;border-radius:50%;
            background:#007AFF;border:2px solid #fff;"></div>
        </div>`;
    }

    function renderUser(lat, lon, heading) {
      lastPos = [lat, lon];
      if (!userMarker) {
        userMarker = L.marker([lat, lon], {
          icon: L.divIcon({
            html: createUserHTML(heading),
            className: '',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
          })
        }).addTo(map);
      } else {
        userMarker.setLatLng([lat, lon]);
        const wedge = userMarker.getElement()?.querySelector('.direction-wedge');
        if (wedge) wedge.style.transform = `rotate(${heading}deg)`;
      }
    }

    /* ========== 方位処理 ========== */
    function applyHeading(rawDeg) {
      if (rawDeg == null) return;
      const corrected = (rawDeg + getScreenAngle()) % 360;
      currentHeading = corrected;
      if (lastPos) renderUser(lastPos[0], lastPos[1], corrected);
    }

    /* ----- 1) AbsoluteOrientationSensor ----- */
    (function initAbs() {
      try {
        if ('AbsoluteOrientationSensor' in window) {
          const sensor = new AbsoluteOrientationSensor({ frequency: 30 });
          sensor.addEventListener('reading', () => {
            const q = sensor.quaternion; // [x,y,z,w]
            const yaw =
              Math.atan2(
                2 * (q[3] * q[2] + q[0] * q[1]),
                1 - 2 * (q[1] * q[1] + q[2] * q[2])
              ) * 180 / Math.PI;
            applyHeading((yaw + 360) % 360);
          });
          sensor.start();
          return;
        }
      } catch (e) { console.warn('AbsoluteOrientationSensor error', e); }
    })();

    /* ----- 2) DeviceOrientation ----- */
    (function initDevOri() {
      function handler(ev) {
        if (ev.webkitCompassHeading != null) return applyHeading(ev.webkitCompassHeading);
        if (ev.alpha != null) return applyHeading((360 - ev.alpha) % 360);
      }
      if (typeof DeviceOrientationEvent !== 'undefined') {
        if (DeviceOrientationEvent.requestPermission) {
          DeviceOrientationEvent.requestPermission()
            .then(r => r === 'granted' && addEventListener('deviceorientation', handler, true))
            .catch(console.error);
        } else {
          addEventListener('deviceorientationabsolute', handler, true);
          addEventListener('deviceorientation', handler, true);
        }
      }
    })();

    /* ----- 3) GPS ベアリング補完 ----- */
    let lastBearingPos = null;
    function gpsHeading(lat, lon) {
      if (!lastBearingPos) { lastBearingPos = [lat, lon]; return null; }
      const [pLat, pLon] = lastBearingPos;
      const dist =
        6371000 *
        2 *
        Math.asin(
          Math.sqrt(
            Math.sin(toRad((lat - pLat) / 2)) ** 2 +
              Math.cos(toRad(pLat)) *
                Math.cos(toRad(lat)) *
                Math.sin(toRad((lon - pLon) / 2)) ** 2
          )
        );
      if (dist < 2) return null; // 2m未満はノイズ
      lastBearingPos = [lat, lon];
      return bearing(pLat, pLon, lat, lon);
    }

    /* ========== Geolocation ========== */
    if ('geolocation' in navigator) {
      navigator.geolocation.watchPosition(
        ({ coords: { latitude, longitude } }) => {
          const fallback = gpsHeading(latitude, longitude);
          if (fallback != null && currentHeading === 0) currentHeading = fallback;
          renderUser(latitude, longitude, currentHeading);
        },
        e => console.error('Geolocation error', e),
        { enableHighAccuracy: true, maximumAge: 2500, timeout: 8000 }
      );
    } else {
      alert('Geolocation API に対応していません。');
    }

    /* ========== 初期化終了 ========== */
    hideDetails(); // 初期は閉じておく
  </script>


  
</body>
</html>
