<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>çµ±åˆãƒãƒƒãƒ—</title>

    <!-- favicon -->
    <link rel="icon" href="./static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="./static/favicon.png" type="image/png">
    <link rel="shortcut icon" href="./static/favicon.ico">

    <!-- ã‚¿ã‚¤ãƒ«ã‚µãƒ¼ãƒãƒ¼ã¸ã®äº‹å‰æ¥ç¶š -->
    <link rel="preconnect" href="https://server.arcgisonline.com">
    <link rel="dns-prefetch" href="https://server.arcgisonline.com">

    <!-- ã‚ˆãä½¿ã†ãƒãƒ¼ã‚«ãƒ¼ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ -->
    <link rel="preload" as="image" href="./static/map/K1å·é¤¨.webp">
    <link rel="preload" as="image" href="./static/map/K2å·é¤¨.webp">

    <link
    rel="stylesheet"
    href="./static/css/map_icons.css"/>

    <!-- Leaflet CSS (é…å»¶èª­ã¿è¾¼ã¿) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      media="print"
      onload="this.media='all'" />
    <noscript>
      <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    </noscript>

    <!-- Bootstrap CSS (é…å»¶èª­ã¿è¾¼ã¿) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      media="print"
      onload="this.media='all'" />
    <noscript>
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    </noscript>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet" />

    <style>
    :root { --brand-green: rgb(14,83,12);  }
   

    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, Helvetica, sans-serif;
      overflow: hidden;            /* ãƒ¢ãƒã‚¤ãƒ«ã§ä½™è¨ˆãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢ */
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ */
    .menu-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(260px, 90%, 640px);
      z-index: 1000;
      display: flex;
      gap: .5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;       /* Firefox */
    }
    .menu-bar::-webkit-scrollbar { display: none; }  /* Chrome/Safari */

    .menu-bar button {
      flex: 1 0 auto;
      white-space: nowrap;
    }




    /* è©³ç´°ãƒ‘ãƒãƒ« */
    .details-panel {
      position: fixed;
      top: 0; left: -400px;
      width: 400px; max-width: 90%;
      height: 100%;
      overflow-y: auto;
      transition: left .3s ease;
      z-index: 1001;
    }
    .details-panel.active {
      left: 0;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨èª¿æ•´ (â‰¤768px) */
    @media (max-width: 768px) {
      .custom-icon {
        width: 40px; height: 40px;
      }
      .custom-icon::after {
        bottom: -9px;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 12px solid rgb(14,83,12);;
      }
      .details-panel {
        width: 100%;
        left: 100%;
      }
      .details-panel.active {
        left: 0;
      }
      .menu-bar {
        bottom: 10px;
        gap: .4rem;
      }
    }


    /* Leaflet ãŒç”Ÿæˆã™ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã®å¤–æ ï¼ˆé€æ˜çŸ©å½¢ï¼‰ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’é€éã•ã›ã‚‹ */
.leaflet-marker-icon{
  pointer-events:none;           /* é€éé ˜åŸŸã¯ã‚¤ãƒ™ãƒ³ãƒˆç„¡åŠ¹ */
}

/* å®Ÿéš›ã®å††å½¢ãƒ”ãƒ³ã¨ãã®å­è¦ç´ ã ã‘ã‚¯ãƒªãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ã‚‹ */
.leaflet-marker-icon .custom-icon,
.leaflet-marker-icon .custom-icon *{
  pointer-events:auto;           /* å††å†…éƒ¨ã‚’æœ‰åŠ¹åŒ– */
}


/* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶å¾¡ã‚’è¿½åŠ  */
.leaflet-marker-icon.custom-marker {
  pointer-events: none !important;
}
.leaflet-marker-icon.custom-marker .custom-icon {
  pointer-events: auto !important;
}

    /* ã‚¹ãƒãƒƒãƒˆãƒãƒ¼ã‚«ãƒ¼ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ */
    .custom-icon.focused {
      width: 60px;
      height: 60px;
      border-color: rgb(14,83,12);           /* é‡‘è‰²ã®æ ã§å¼·èª¿ */
    }
    .custom-icon.focused::after {
      bottom: -15px;                    /* çŸ¢å°ã®ä½ç½®ã‚’å°‘ã—ä¸‹ã¸ */
      border-top-width: 18px;           /* çŸ¢å°ã‚’å°‘ã—å¤§ãã */
      border-top-color: rgb(14,83,12);        /* çŸ¢å°ã®è‰²ã‚‚é‡‘è‰²ã« */
    }
    .custom-icon.focused .icon-image {
      width: 90%;
      height: 90%;
    }

/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
#back-btn {
  position: fixed !important;
  top: 1.5rem !important;
  left: 5rem !important;
  z-index: 2000 !important;

  display: inline-flex !important;
  align-items: center;
  gap: 0.4rem;
  height: 55px;
  
  padding: 0.4rem 0.8rem;
  border: 2px solid rgba(42, 235, 225, 0.9);
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.5);
  color: rgba(182, 24, 230, 0.9);
  text-decoration: none;
  font-weight: bold;
  font-size: 0.9rem;

  transition: background-color 0.25s ease,
              color 0.25s ease,
              transform 0.2s ease;
}
#back-btn i {
  font-size: 1.2rem;
  line-height: 1;
}
#back-btn span {
  line-height: 1;
}

/* ãƒ›ãƒãƒ¼ãƒ»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ */
#back-btn:hover {
  background: rgba(43, 236, 172, 0.4);
  color: #fff;
  transform: translateX(-3px);
}
#back-btn:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(18, 45, 202, 0.4);
}
  </style>

<style>
/* ç‰¹å®šã®ã‚¨ãƒªã‚¢ã‚’å›²ã‚€ */
.my-area-boundary {
  /* ç·šã®è‰² */
  stroke: #36ffe4;
  /* ç·šã®å¤ªã• */
  stroke-width: 3;
  /* ç ´ç·šã«ã—ãŸã„å ´åˆ */
  stroke-dasharray: 8, 4;
  /* å¡—ã‚Šã¤ã¶ã—ãªã— */
  fill-opacity: 0;
  /* ãƒã‚¦ã‚¹æ“ä½œã‚’ç„¡åŠ¹åŒ–ã—ãŸã„å ´åˆ */
  pointer-events: none;
}
</style>

  </head>

  <body>
    <!-- â† ã“ã“ã‹ã‚‰è¿½åŠ ï¼šæˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
<a id="back-btn" href="/" class="position-fixed">
  <i class="bi bi-arrow-left"></i>
  <span>æˆ»ã‚‹</span>
</a>


    <div id="map"></div>

    <!-- è©³ç´°ãƒ‘ãƒãƒ« -->
    <div id="details-panel" class="details-panel bg-white shadow p-3">
      <button class="btn-close float-end" onclick="hideDetails()"></button>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ -->
    <div
      class="menu-bar bg-white shadow rounded-pill p-2 d-flex gap-2 align-items-center">
      <button class="btn btn-light">ğŸ  å…¨ä½“</button>
      <button class="btn btn-light">ğŸ” ç ”ç©¶å®¤</button>
      <button class="btn btn-light">ğŸ´ ã‚°ãƒ«ãƒ¡</button>
      <button class="btn btn-light">ğŸ›ï¸ ã‚µãƒ¼ã‚¯ãƒ«</button>
      <button class="btn btn-light">ğŸ“„ æ¼”å¥ãƒ»åŠ‡</button>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ã®ã©ã“ã‹ã«è¿½åŠ ï¼ˆbody ã®æœ€å¾Œã‚ãŸã‚Šï¼‰ -->
    <div class="modal fade" id="compassModal" tabindex="-1"
      aria-labelledby="compassModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="compassModalLabel">ã‚³ãƒ³ãƒ‘ã‚¹ã®ä½¿ç”¨è¨±å¯</h5>
          </div>
          <div class="modal-body">
            åœ°å›³ä¸Šã«å‘ãã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã‚³ãƒ³ãƒ‘ã‚¹ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚
          </div>
          <div class="modal-footer">
            <button type="button" id="denyCompass" class="btn btn-secondary"
              data-bs-dismiss="modal">è¨±å¯ã—ãªã„</button>
            <button type="button" id="allowCompass"
              class="btn btn-primary">è¨±å¯ã™ã‚‹</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

      <script>
        // å®šæ•°ã¨åœ°å›³åˆæœŸåŒ–
        const INITIAL_CENTER = [35.486417749642015, 139.3428098153942];
        const map = L.map('map', {
          center: INITIAL_CENTER,
          zoom: 18,               // åˆæœŸã‚ºãƒ¼ãƒ ã‚’ 18 ã«
          minZoom: 5,             // æœ€å°ã‚ºãƒ¼ãƒ 
          maxZoom: 19,            // æœ€å¤§ã‚ºãƒ¼ãƒ 
          zoomControl: true,
          scrollWheelZoom: true,
          touchZoom: true
        });
      
        // å»ºç‰©ãƒ”ãƒ³ã‚’ã¾ã¨ã‚ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼
        const buildingLayer = L.layerGroup().addTo(map);
      
        // èª¤ã‚¿ãƒƒãƒ—ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ãƒ•ãƒ©ã‚°ã¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒãƒ¼ã‚«ãƒ¼
        let cancelNextMarkerClick = false;
        let focusedMarker = null;
      
        // è©³ç´°ãƒ‘ãƒãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        let detailsOverlay = null;
      
        // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼
        L.tileLayer(
          "https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg",
          {
            attribution: 'â€¦',
            maxNativeZoom: 18,
            maxZoom: 19,
          }
        ).addTo(map);
      
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const toRad = d => (d * Math.PI) / 180;
        const toDeg = r => (r * 180) / Math.PI;
        const EARTH_R = 6371000;
        function getScreenAngle() {
          return (
            (screen.orientation && screen.orientation.angle) ||
            window.orientation ||
            0
          );
        }
        function calcBearing(lat1, lon1, lat2, lon2) {
          const Ï†1 = toRad(lat1),
                Ï†2 = toRad(lat2),
                Î»1 = toRad(lon1),
                Î»2 = toRad(lon2);
          const y = Math.sin(Î»2 - Î»1) * Math.cos(Ï†2);
          const x =
            Math.cos(Ï†1) * Math.sin(Ï†2) -
            Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î»2 - Î»1);
          return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }
      
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
        function createCustomIcon(url) {
          return L.divIcon({
            className: "custom-marker",
            html: `<div class="custom-icon"><div class="icon-image" style="background-image:url('${url}')"></div></div>`,
            iconSize: [50, 60],
            iconAnchor: [25, 60],
          });
        }
      
        // ã‚¹ãƒãƒƒãƒˆä¸€è¦§
        const spots = [
          { location: [35.48604116703019, 139.34128951057255], image: "./static/map/K1å·é¤¨.webp", name: "K1å·é¤¨" },
          { location: [35.48650866834297, 139.34112683577234], image: "./static/map/K2å·é¤¨.webp", name: "K2å·é¤¨" },
          { location: [35.48565158052546, 139.34141709865116], image: "./static/map/K3å·é¤¨.webp", name: "K3å·é¤¨" },
          { location: [35.485683613095844, 139.3419922129912], image: "./static/map/K4å·é¤¨.webp", name: "K4å·é¤¨" },
          { location: [35.485597402140684, 139.34321173217694], image: "./static/map/KAITã‚¢ãƒªãƒ¼ãƒŠ.webp", name: "KAITã‚¢ãƒªãƒ¼ãƒŠ" },
          { location: [35.4860692562503, 139.34187073632998], image: "./static/map/å…ˆé€²ç ”.webp", name: "å…ˆé€²ç ”" },
          { location: [35.48714378031437, 139.34102852276388], image: "./static/map/ãƒã‚¤ã‚ªæ£Ÿ.webp", name: "ãƒã‚¤ã‚ªæ£Ÿ" },
          { location: [35.4876058212225, 139.34111663074825], image: "./static/map/è‡ªå‹•è»Šæ£Ÿ.webp", name: "è‡ªå‹•è»Šæ£Ÿ" },
          { location: [35.48768007599212, 139.34208759034047], image: "./static/map/ãƒ­ãƒœãƒƒãƒˆ.webp", name: "ãƒ­ãƒœãƒƒãƒˆ" },
          { location: [35.48638279161658, 139.34182473387625], image: "./static/map/åºƒå ´.webp", name: "åºƒå ´" },
          { location: [35.487920311541316, 139.3430478210974], image: "./static/map/è‡ªå‹•è»Šå·¥æˆ¿.webp", name: "è‡ªå‹•è»Šå·¥æˆ¿" },
          { location: [35.4867846462545, 139.34246309957499], image: "./static/map/KAITå·¥æˆ¿.webp", name: "KAITå·¥æˆ¿" },
          { location: [35.486649238937936, 139.34321411804413], image: "./static/map/KAITåºƒå ´.webp", name: "KAITåºƒå ´" },
          { location: [35.44134206079602, 139.3663787109304], image: "./static/map/åšæœ¨ãƒã‚¹ã‚»ãƒ³ã‚¿ãƒ¼.webp", name: "åšæœ¨ãƒã‚¹ã‚»ãƒ³ã‚¿ãƒ¼" },
          { location: [35.44012426180783, 139.36467281666947], image: "./static/map/æœ¬åšæœ¨é§…å‰ãƒã‚¹åœ.webp", name: "æœ¬åšæœ¨é§…å‰ãƒã‚¹åœ" },
          { location: [35.48543014113195, 139.34095161222936], image: "./static/map/ç¥å¥ˆå·å·¥ç§‘å¤§å­¦å‰ãƒã‚¹åœ.webp", name: "ç¥å¥ˆå·å·¥ç§‘å¤§å­¦å‰ãƒã‚¹åœ" },
          { location: [35.48549264919395, 139.3410855002179], image: "./static/map/æœ¬åšæœ¨é§…ç›´è¡Œãƒã‚¹åœ.webp", name: "æœ¬åšæœ¨é§…ç›´è¡Œãƒã‚¹åœ" },
        ];
      
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆ¶å¾¡
        function focusMarker(marker){
          const el = marker.getElement()?.querySelector('.custom-icon');
          if (el) el.classList.add('focused');
        }
        function unfocusMarker(marker){
          const el = marker.getElement()?.querySelector('.custom-icon');
          if (el) el.classList.remove('focused');
        }
      
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’é †æ¬¡ãƒ­ãƒ¼ãƒ‰
        function loadMarkersSequentially(interval = 150) {
          spots.forEach((s, idx) => {
            setTimeout(() => {
              const m = L.marker(s.location, { icon: createCustomIcon(s.image) })
                .on('click', function(ev) {
                  // ç©ºç™½ã‚¯ãƒªãƒƒã‚¯ç›´å¾Œã®èª¤ã‚¿ãƒƒãƒ—é˜²æ­¢
                  if (cancelNextMarkerClick) {
                    cancelNextMarkerClick = false;
                    return;
                  }
                  ev.originalEvent?.preventDefault();
                  ev.originalEvent?.stopPropagation();
                  L.DomEvent.stopPropagation(ev);
      
                  showDetails({
                    image:       s.image,
                    name:        s.name,
                    description: "ã“ã“ã«ã‚¹ãƒãƒƒãƒˆã®èª¬æ˜",
                    address:     "ä½æ‰€",
                    phone:       "é›»è©±ç•ªå·"
                  });
      
                  if (focusedMarker && focusedMarker !== m) {
                    unfocusMarker(focusedMarker);
                  }
                  focusMarker(m);
                  focusedMarker = m;
                });
              buildingLayer.addLayer(m);
              s.marker = m;
            }, interval * idx);
          });
        }
      
        // è©³ç´°ãƒ‘ãƒãƒ«è¡¨ç¤º
        function showDetails(c) {
          const p = document.getElementById("details-panel");
          p.innerHTML = `
            <button class="btn-close float-end" onclick="hideDetails()"></button>
            <img src="${c.image}" alt="${c.name}" class="img-fluid rounded mb-3">
            <h2 class="fs-4">${c.name}</h2>
            <p class="text-muted mb-3">${c.description}</p>
            <div class="border-top pt-3">
              <div><strong>ä½æ‰€:</strong> ${c.address}</div>
              <div><strong>é›»è©±ç•ªå·:</strong> ${c.phone}</div>
            </div>`;
          p.classList.add("active");
      
          if (!detailsOverlay) {
            detailsOverlay = document.createElement("div");
            detailsOverlay.style.cssText = `
              position:fixed; inset:0;
              z-index:1000;
              background:transparent;
              cursor:pointer;
            `;
            L.DomEvent.disableClickPropagation(detailsOverlay);
            L.DomEvent.disableScrollPropagation(detailsOverlay);
            detailsOverlay.addEventListener("click", function(ev) {
              ev.preventDefault();
              ev.stopPropagation();
              hideDetails();
              cancelNextMarkerClick = false;
            });
          }
          if (!detailsOverlay.isConnected) document.body.appendChild(detailsOverlay);
        }
      
        // è©³ç´°ãƒ‘ãƒãƒ«éè¡¨ç¤º
        function hideDetails() {
          const p = document.getElementById("details-panel");
          p.classList.remove("active");
          if (detailsOverlay && detailsOverlay.isConnected) {
            detailsOverlay.remove();
          }
          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤ã¯ã“ã“ã§ã¯è¡Œã‚ãªã„
        }
      
        // ç©ºç™½ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤
        function isNearAnyMarker(clickLatLng, thresholdPx = 15) {
          const clickPt = map.latLngToContainerPoint(clickLatLng);
          let hit = false;
          buildingLayer.eachLayer(m => {
            if (hit) return;
            const mPt = map.latLngToContainerPoint(m.getLatLng());
            if (clickPt.distanceTo(mPt) < thresholdPx) hit = true;
          });
          return hit;
        }
      
        map.on('mousedown', function (ev) {
          if (!ev.originalEvent.target.closest('.custom-icon')) {
            cancelNextMarkerClick = true;
          }
        });
        map.on("click", function(ev) {
          if (!isNearAnyMarker(ev.latlng)) {
            hideDetails();
            cancelNextMarkerClick = false;
            if (focusedMarker) {
              unfocusMarker(focusedMarker);
              focusedMarker = null;
            }
          }
        });
      
        // åˆå›ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç–‘ä¼¼ã‚¯ãƒªãƒƒã‚¯ç”¨ãƒ•ãƒ©ã‚°
        let initialMenuSimulated = false;
      
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œ
        document.addEventListener('DOMContentLoaded', () => {
          loadMarkersSequentially();
      
          // ä¸€åº¦ã ã‘ã€Œç ”ç©¶å®¤ã€â†’ã€Œå…¨ä½“ã€ã‚’ç´ æ—©ãç–‘ä¼¼ã‚¯ãƒªãƒƒã‚¯
          setTimeout(() => {
            if (!initialMenuSimulated) {
              initialMenuSimulated = true;
              document.querySelector('.menu-bar button:nth-child(2)')?.click(); // ç ”ç©¶å®¤
              document.querySelector('.menu-bar button:nth-child(1)')?.click(); // å…¨ä½“
            }
          }, 500);
        });
      
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ï¼†ã‚³ãƒ³ãƒ‘ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«
        document.addEventListener('DOMContentLoaded', () => {
          const compassModal = new bootstrap.Modal(document.getElementById('compassModal'), {
            backdrop: 'static',
            keyboard: false
          });
          compassModal.show();
      
          document.getElementById('allowCompass').addEventListener('click', () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
              DeviceOrientationEvent.requestPermission()
                .then(resp => {
                  if (resp === 'granted') initCompass();
                })
                .finally(() => compassModal.hide());
            } else {
              initCompass();
              compassModal.hide();
            }
          });
      
          document.getElementById('denyCompass').addEventListener('click', () => {
            console.warn('Compass use denied by user');
            compassModal.hide();
          });
        });
      
        // ã‚³ãƒ³ãƒ‘ã‚¹åˆæœŸåŒ–
        function initCompass() {
          try {
            if ('AbsoluteOrientationSensor' in window) {
              const sensor = new AbsoluteOrientationSensor({ frequency: 30 });
              sensor.addEventListener('reading', () => {
                const [x, y, z, w] = sensor.quaternion;
                const yaw = (Math.atan2(2*(w*z + x*y), 1 - 2*(y*y + z*z)) * 180) / Math.PI;
                applyHeading((yaw + 360) % 360);
              });
              sensor.start();
              return;
            }
          } catch (e) {
            console.warn('AbsoluteOrientationSensor error:', e);
          }
          const handler = ev => {
            if (ev.webkitCompassHeading != null) {
              applyHeading(ev.webkitCompassHeading);
            } else if (ev.alpha != null) {
              applyHeading((360 - ev.alpha) % 360);
            }
          };
          if (typeof DeviceOrientationEvent !== 'undefined') {
            if (DeviceOrientationEvent.requestPermission) {
              DeviceOrientationEvent.requestPermission()
                .then(r => {
                  if (r === 'granted') window.addEventListener('deviceorientation', handler, true);
                })
                .catch(console.error);
            } else {
              window.addEventListener('deviceorientationabsolute', handler, true);
              window.addEventListener('deviceorientation', handler, true);
            }
          }
        }
      
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼æç”»
        let userMarker = null;
        let lastPos = null;
        let currentHeading = 0;
      
        function userHTML(heading) {
          return `
            <div style="position:relative;width:40px;height:40px">
              <div class="direction-wedge" style="
                position:absolute;
                top:-20px; left:-20px;
                width:80px; height:80px;
                background: radial-gradient(
                  circle at 50% 50%,
                  rgba(0,122,255,3.6) 0%,
                  rgba(0,122,255,0) 80%
                );
                clip-path: polygon(50% 50%,25% 0%,75% 0%);
                transform: rotate(${heading}deg);
                transform-origin: 40px 40px;
              "></div>
              <div style="
                position:absolute;
                top:0; left:0;
                width:40px; height:40px;
                border-radius:50%;
                background: rgba(0,122,255,0.4);
                border: 2px solid rgba(0,122,255,0.6);
              "></div>
              <div style="
                position:absolute;
                top:8px; left:8px;
                width:24px; height:24px;
                border-radius:50%;
                background: #005FCC;
                border: 2px solid #fff;
              "></div>
            </div>`;
        }
      
        function renderUser(lat, lon, heading) {
          lastPos = [lat, lon];
          if (!userMarker) {
            userMarker = L.marker([lat, lon], {
              icon: L.divIcon({
                html: userHTML(heading),
                className: "",
                iconSize: [40, 40],
                iconAnchor: [20, 20],
              }),
            }).addTo(map);
          } else {
            userMarker.setLatLng([lat, lon]);
            userMarker.setIcon(
              L.divIcon({
                html: userHTML(heading),
                className: "",
                iconSize: [40, 40],
                iconAnchor: [20, 20],
              })
            );
          }
        }
      
        function applyHeading(raw) {
          if (raw == null) return;
          const deg = (raw + getScreenAngle()) % 360;
          currentHeading = deg;
          if (lastPos) renderUser(lastPos[0], lastPos[1], deg);
        }
      
        // GPSãƒ™ã‚¢ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹å‘ãè£œå®Œ
        let lastBearingPos = null;
        function gpsBearing(lat, lon) {
          if (!lastBearingPos) {
            lastBearingPos = [lat, lon];
            return null;
          }
          const [pl, pn] = lastBearingPos;
          const d = EARTH_R * 2 * Math.asin(
            Math.sqrt(
              Math.sin(toRad((lat - pl) / 2))**2 +
              Math.cos(toRad(pl)) * Math.cos(toRad(lat)) * Math.sin(toRad((lon - pn) / 2))**2
            )
          );
          if (d < 2) return null;
          lastBearingPos = [lat, lon];
          return calcBearing(pl, pn, lat, lon);
        }
      
        // ä½ç½®æƒ…å ±å–å¾—
        if ('geolocation' in navigator) {
          navigator.geolocation.watchPosition(
            ({ coords: { latitude, longitude } }) => {
              const fallback = gpsBearing(latitude, longitude);
              if (fallback != null && currentHeading === 0) currentHeading = fallback;
              renderUser(latitude, longitude, currentHeading);
            },
            e => {
              if (e.code === e.TIMEOUT) {
                console.warn('ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¾ã™â€¦');
              } else {
                console.error('Geolocation error', e);
              }
            },
            {
              enableHighAccuracy: true,
              maximumAge: 5000,
              timeout: 20000
            }
          );
        } else {
          alert('Geolocation API ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        }
      
        // åˆæœŸçŠ¶æ…‹ã§è©³ç´°ãƒ‘ãƒãƒ«ã‚’éš ã™
        hideDetails();
      
        // iframe ç­‰ã‹ã‚‰ã‚‚å‚ç…§å¯èƒ½ã«
        window.spots = spots;
        window.map   = map;
      </script>
      
      
      <script>
// ä¾‹ï¼šå›²ã¿ãŸã„ã‚¨ãƒªã‚¢ã®ç·¯åº¦çµŒåº¦ãƒªã‚¹ãƒˆ
const areaCoords = [
  //å·¦ä¸Š
  [35.487860530019944, 139.34037514269602],
  //å³ä¸Š
  [35.48819249093486, 139.34462376154906],
  //å³ä¸‹
  [35.485091223681984, 139.3459004930207],
  //å·¦ä¸‹
  [35.48510869594534, 139.3409437710255]
];

// ãƒãƒªã‚´ãƒ³ã‚’ä½œæˆã—ã€ãƒãƒƒãƒ—ã«è¿½åŠ 
const areaBoundary = L.polygon(areaCoords, {
  // CSS ã‚¯ãƒ©ã‚¹åã‚’æŒ‡å®šï¼ˆå…ˆã»ã©ä½œã£ãŸ .my-area-boundary ãŒé©ç”¨ã•ã‚Œã‚‹ï¼‰
  className: 'my-area-boundary',
  // å¿…è¦ã§ã‚ã‚Œã°å¡—ã‚Šè‰²ã‚’è¨­å®šï¼ˆCSS ã§åˆ¶å¾¡ã—ãŸã‘ã‚Œã°ä¸è¦ï¼‰
  // fill: false 
}).addTo(map);

      </script>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      defer></script>
    <script src="./static/js/eventsData.js" defer></script>
    <script src="./static/js/events.js" defer></script>
  </body>
</html>
