<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>統合マップ</title>

    <!-- favicon -->
    <link rel="icon" href="./static/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="./static/favicon.png">
    <link rel="shortcut icon" href="./static/favicon.ico">

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet">

    <style>
    :root { --brand-green: rgb(14,83,12); }

    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, Helvetica, sans-serif;
      overflow: hidden;            /* モバイルで余計なスクロールを防止 */
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    /* 地図タイルの色調補正 */
    .leaflet-tile-pane img {
      filter: saturate(1.8) contrast(1.2) brightness(1.0);
    }

    /* メニューバー */
    .menu-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(260px, 90%, 640px);
      z-index: 1000;
      display: flex;
      gap: .5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;       /* Firefox */
    }
    .menu-bar::-webkit-scrollbar { display: none; }  /* Chrome/Safari */

    .menu-bar button {
      flex: 1 0 auto;
      white-space: nowrap;
    }

    /* カスタムピン */
    .custom-icon {
      position: relative;
      z-index: 1;
      width: 50px; height: 50px;
      background: var(--brand-green);
      border: 2px solid #ccc;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .custom-icon::after {
      content: '';
      position: absolute;
      left: 50%; bottom: -11px;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 15px solid var(--brand-green);
      z-index: -1;
    }
    .icon-image {
      width: 90%; height: 90%;
      background-size: cover;
      background-position: center;
      border-radius: 50%;
      border: 1px solid #aaa;
    }

    /* 詳細パネル */
    .details-panel {
      position: fixed;
      top: 0; left: -400px;
      width: 400px; max-width: 90%;
      height: 100%;
      overflow-y: auto;
      transition: left .3s ease;
      z-index: 1001;
    }
    .details-panel.active {
      left: 0;
    }

    /* モバイル用調整 (≤768px) */
    @media (max-width: 768px) {
      .custom-icon {
        width: 40px; height: 40px;
      }
      .custom-icon::after {
        bottom: -9px;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 12px solid var(--brand-green);
      }
      .details-panel {
        width: 100%;
        left: 100%;
      }
      .details-panel.active {
        left: 0;
      }
      .menu-bar {
        bottom: 10px;
        gap: .4rem;
      }
    }


  /* 戻るボタンがマップ上に重なるように */
  #back-btn {
    position: fixed;
    top: 20px;
    left: 70px;
    z-index: 999;

    /* サイズアップ */
    padding: 0.6rem 1.0rem;   /* 縦横ともに広めに */
    font-size: 1.0rem;        /* 少し大きめの文字 */

    /* 見た目 */
    background-color: #3fe1f7;
    color: #000000;
    border: none;
  }
  #back-btn .bi-arrow-left {
    font-size: 1.0rem;
    vertical-align: middle;
  }


  </style>

  </head>

  <body>
    <!-- ← ここから追加：戻るボタン -->
    <a id="back-btn" href="/" class="btn btn-light btn-lg">
      <i class="bi bi-arrow-left"></i> 戻る
    </a>
  

    <div id="map"></div>

    <!-- 詳細パネル -->
    <div id="details-panel" class="details-panel bg-white shadow p-3">
      <button class="btn-close float-end" onclick="hideDetails()"></button>
    </div>

    <!-- メニューバー -->
    <div
      class="menu-bar bg-white shadow rounded-pill p-2 d-flex gap-2 align-items-center">
      <button class="btn btn-light">🏠 すべて</button>
      <button class="btn btn-light">🔍 検索</button>
      <button class="btn btn-light">🍴 グルメ</button>
      <button class="btn btn-light">🛍️ ショッピング</button>
      <button class="btn btn-light">📄 詳細情報</button>
    </div>


    <!-- ページのどこかに追加（body の最後あたり） -->
<div class="modal fade" id="compassModal" tabindex="-1" aria-labelledby="compassModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="compassModalLabel">コンパスの使用許可</h5>
      </div>
      <div class="modal-body">
        地図上に向きを表示するにはコンパスの使用を許可してください。
      </div>
      <div class="modal-footer">
        <button type="button" id="denyCompass" class="btn btn-secondary" data-bs-dismiss="modal">許可しない</button>
        <button type="button" id="allowCompass" class="btn btn-primary">許可する</button>
      </div>
    </div>
  </div>
</div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

      <script>
        // 定数と地図初期化
        const INITIAL_CENTER = [35.486417749642015, 139.3428098153942];
        const map = L.map('map').setView(INITIAL_CENTER, 18);
        L.tileLayer(
          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
          {
            attribution:
              '&copy; <a href="https://www.esri.com/">Esri</a>, Maxar, Earthstar Geographics',
            maxZoom: 18,
          }
        ).addTo(map);
        
        // ユーティリティ関数
        const toRad = d => (d * Math.PI) / 180;
        const toDeg = r => (r * 180) / Math.PI;
        const EARTH_R = 6371000;
        function getScreenAngle() {
          return (
            (screen.orientation && screen.orientation.angle) ||
            window.orientation ||
            0
          );
        }
        function calcBearing(lat1, lon1, lat2, lon2) {
          const φ1 = toRad(lat1),
                φ2 = toRad(lat2),
                λ1 = toRad(lon1),
                λ2 = toRad(lon2);
          const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
          const x =
            Math.cos(φ1) * Math.sin(φ2) -
            Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);
          return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }
        
        // スポットマーカー
        function createCustomIcon(url) {
          return L.divIcon({
            className: "",
            html: `<div class="custom-icon"><div class="icon-image" style="background-image:url('${url}')"></div></div>`,
            iconSize: [50, 60],
            iconAnchor: [25, 60],
          });
        }
        const spots = [
          { location: [35.48604116703019, 139.34128951057255], image: "./static/map/K1号館.webp", name: "K1号館" },
          { location: [35.48650866834297, 139.34112683577234], image: "./static/map/K2号館.webp", name: "K2号館" },
          { location: [35.48565158052546, 139.34141709865116], image: "./static/map/K3号館.webp", name: "K3号館" },
          { location: [35.485683613095844, 139.3419922129912], image: "./static/map/K4号館.webp", name: "K4号館" },
          { location: [35.485597402140684, 139.34321173217694], image: "./static/map/KAITアリーナ.webp", name: "KAITアリーナ" },
          { location: [35.4860692562503, 139.34187073632998], image: "./static/map/先進研.webp", name: "先進研" },
          { location: [35.48714378031437, 139.34102852276388], image: "./static/map/バイオ棟.webp", name: "バイオ棟" },
          { location: [35.4876058212225, 139.34111663074825], image: "./static/map/自動車棟.webp", name: "自動車棟" },
          { location: [35.48768007599212, 139.34208759034047], image: "./static/map/ロボット.webp", name: "ロボット" },
          { location: [35.48638279161658, 139.34182473387625], image: "./static/map/広場.webp", name: "広場" },
          { location: [35.487920311541316, 139.3430478210974], image: "./static/map/自動車工房.webp", name: "自動車工房" },
          { location: [35.4867846462545, 139.34246309957499], image: "./static/map/KAIT工房.webp", name: "KAIT工房" },
          { location: [35.486649238937936, 139.34321411804413], image: "./static/map/KAIT広場.webp", name: "KAIT広場" },
          
          { location: [35.44134206079602, 139.3663787109304], image: "./static/sunset.webp", name: "厚木バスセンター" },
          { location: [35.44012426180783, 139.36467281666947], image: "./static/map/本厚木駅前バス停.webp", name: "本厚木駅前バス停" },
          
          { location: [35.48543014113195, 139.34095161222936], image: "./static/map/神奈川工科大学前バス停.webp", name: "神奈川工科大学前バス停" },
          { location: [35.48549264919395, 139.3410855002179], image: "./static/sunset.webp", name: "本厚木駅直行バス停" },
        
        
        ];
        spots.forEach(s =>
          L.marker(s.location, { icon: createCustomIcon(s.image) })
            .addTo(map)
            .on("click", () =>
              showDetails({
                image: s.image,
                name: s.name,
                description: "ここにスポットの説明が表示されます。",
                address: "東京都品川区東八潮1",
                phone: "00-1234-5678",
              })
            )
        );
        
        // 詳細パネル
        function showDetails(c) {
          const p = document.getElementById("details-panel");
          p.innerHTML = `
            <button class="btn-close float-end" onclick="hideDetails()"></button>
            <img src="${c.image}" alt="${c.name}" class="img-fluid rounded mb-3">
            <h2 class="fs-4">${c.name}</h2>
            <p class="text-muted mb-3">${c.description}</p>
            <div class="border-top pt-3">
              <div><strong>住所:</strong> ${c.address}</div>
              <div><strong>電話番号:</strong> ${c.phone}</div>
            </div>`;
          p.classList.add("active");
        }
        function hideDetails() {
          document.getElementById("details-panel").classList.remove("active");
        }
        map.on("click", hideDetails);
        
        // ユーザーマーカーと向き
        let userMarker = null;
        let lastPos = null;
        let currentHeading = 0;

// ユーザーマーカーと向き（色を濃く強調）
function userHTML(heading) {
  return `
    <div style="position:relative;width:40px;height:40px">
      <!-- 方向ウェッジ -->
      <div class="direction-wedge" style="
        position:absolute;
        top:-20px; left:-20px;
        width:80px; height:80px;
        /* 内側の青を不透明度0.6にして濃く */
        background: radial-gradient(
          circle at 50% 50%,
          rgba(0,122,255,30) 0%,
          rgba(0,122,255,0) 80%
        );
        clip-path: polygon(50% 50%,25% 0%,75% 0%);
        transform: rotate(${heading}deg);
        transform-origin: 40px 40px;
      "></div>

      <!-- 外側サークル -->
      <div style="
        position:absolute;
        top:0; left:0;
        width:40px; height:40px;
        border-radius:50%;
        /* 背景を不透明度0.4に、境界線も濃く */
        background: rgba(0,122,255,0.4);
        border: 2px solid rgba(0,122,255,0.6);
      "></div>

      <!-- 中央ドット -->
      <div style="
        position:absolute;
        top:8px; left:8px;
        width:24px; height:24px;
        border-radius:50%;
        /* 中央の青も少し濃い目に */
        background: #005FCC;
        border: 2px solid #fff;
      "></div>
    </div>`;
}


        function renderUser(lat, lon, heading) {
          lastPos = [lat, lon];
          if (!userMarker) {
            userMarker = L.marker([lat, lon], {
              icon: L.divIcon({
                html: userHTML(heading),
                className: "",
                iconSize: [40, 40],
                iconAnchor: [20, 20],
              }),
            }).addTo(map);
          } else {
            userMarker.setLatLng([lat, lon]);
            userMarker.setIcon(
              L.divIcon({
                html: userHTML(heading),
                className: "",
                iconSize: [40, 40],
                iconAnchor: [20, 20],
              })
            );
          }
        }
        function applyHeading(raw) {
          if (raw == null) return;
          const deg = (raw + getScreenAngle()) % 360;
          currentHeading = deg;
          if (lastPos) renderUser(lastPos[0], lastPos[1], deg);
        }
        
        // コンパス許可モーダル
        document.addEventListener('DOMContentLoaded', () => {
          const compassModal = new bootstrap.Modal(document.getElementById('compassModal'), {
            backdrop: 'static',
            keyboard: false
          });
          compassModal.show();
        
          document.getElementById('allowCompass').addEventListener('click', () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
              DeviceOrientationEvent.requestPermission()
                .then(resp => {
                  if (resp === 'granted') initCompass();
                  else console.warn('DeviceOrientation permission denied');
                })
                .catch(err => console.error('Compass request error', err))
                .finally(() => compassModal.hide());
            } else {
              initCompass();
              compassModal.hide();
            }
          });
        
          document.getElementById('denyCompass').addEventListener('click', () => {
            console.warn('Compass use denied by user');
            compassModal.hide();
          });
        });
        
        // 方位取得初期化
        function initCompass() {
          // 1) AbsoluteOrientationSensor
          try {
            if ('AbsoluteOrientationSensor' in window) {
              const sensor = new AbsoluteOrientationSensor({ frequency: 30 });
              sensor.addEventListener('reading', () => {
                const [x, y, z, w] = sensor.quaternion;
                const yaw = (Math.atan2(2*(w*z + x*y), 1 - 2*(y*y + z*z)) * 180) / Math.PI;
                applyHeading((yaw + 360) % 360);
              });
              sensor.start();
              return;
            }
          } catch (e) {
            console.warn('AbsoluteOrientationSensor error:', e);
          }
        
          // 2) DeviceOrientationEvent
          const handler = ev => {
            if (ev.webkitCompassHeading != null) {
              applyHeading(ev.webkitCompassHeading);
            } else if (ev.alpha != null) {
              applyHeading((360 - ev.alpha) % 360);
            }
          };
          if (typeof DeviceOrientationEvent !== 'undefined') {
            if (DeviceOrientationEvent.requestPermission) {
              DeviceOrientationEvent.requestPermission()
                .then(r => {
                  if (r === 'granted') window.addEventListener('deviceorientation', handler, true);
                })
                .catch(console.error);
            } else {
              window.addEventListener('deviceorientationabsolute', handler, true);
              window.addEventListener('deviceorientation', handler, true);
            }
          }
        }
        
        // GPSベクトルによる向き補完
        let lastBearingPos = null;
        function gpsBearing(lat, lon) {
          if (!lastBearingPos) {
            lastBearingPos = [lat, lon];
            return null;
          }
          const [pl, pn] = lastBearingPos;
          const d = EARTH_R * 2 * Math.asin(
            Math.sqrt(
              Math.sin(toRad((lat - pl) / 2))**2 +
              Math.cos(toRad(pl)) * Math.cos(toRad(lat)) * Math.sin(toRad((lon - pn) / 2))**2
            )
          );
          if (d < 2) return null;
          lastBearingPos = [lat, lon];
          return calcBearing(pl, pn, lat, lon);
        }
        
        // 位置情報取得
        if ('geolocation' in navigator) {
          navigator.geolocation.watchPosition(
            ({ coords: { latitude, longitude } }) => {
              const fallback = gpsBearing(latitude, longitude);
              if (fallback != null && currentHeading === 0) currentHeading = fallback;
              renderUser(latitude, longitude, currentHeading);
            },
            e => console.error('Geolocation error', e),
            { enableHighAccuracy: true, maximumAge: 1500, timeout: 7000 }
          );
        } else {
          alert('Geolocation API に対応していません。');
        }
        
        // 初期詳細パネル非表示
        hideDetails();
        </script>
        

  </body>
</html>
